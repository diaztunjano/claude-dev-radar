#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_epic() {
    echo -e "${PURPLE}[EPIC]${NC} $1"
}

log_generate() {
    echo -e "${CYAN}[GENERATE]${NC} $1"
}

# Display usage
show_usage() {
    echo "üéØ JANOME ISSUE GENERATOR - GitHub Integration"
    echo "============================================="
    echo ""
    echo "Creates atomic issues directly in GitHub following C.I.D.E.R. protocol"
    echo ""
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "COMMANDS:"
    echo "  analyze <requirement>     - Analyze requirement and suggest epic structure"
    echo "  generate <epic> <feature> - Generate & create atomic issue in GitHub"
    echo "  validate <input>          - Validate GitHub issue or local file"
    echo "  list-epics               - Show available epics and their modules"
    echo "  template                 - Generate empty issue template (local file)"
    echo ""
    echo "REQUIREMENTS:"
    echo "  üìã Claude Code installed and authenticated"
    echo "  üêô GitHub CLI (gh) installed and authenticated: gh auth login"
    echo "  üìÅ Run from Janome project root directory"
    echo ""
    echo "GENERATE OPTIONS:"
    echo "  epic: EPIC-TALLERES, EPIC-ASISTENTES, EPIC-EQUIPOS, EPIC-RECORDATORIOS,"
    echo "        EPIC-USUARIOS, EPIC-IA-WHATSAPP, EPIC-DASHBOARD, EPIC-PERFORMANCE, EPIC-DOCS"
    echo "  feature: Brief description of the feature"
    echo ""
    echo "VALIDATE OPTIONS:"
    echo "  input: GitHub issue number (e.g., 123) or local file path"
    echo ""
    echo "EXAMPLES:"
    echo "  $0 analyze \"Implementar sistema de evaluaciones post-taller\""
    echo "  $0 generate EPIC-TALLERES \"widget confirmacion asistencia\""
    echo "  $0 validate 123  # Validates GitHub issue #123"
    echo "  $0 validate specs/01_FEATURES/[FEAT]-nueva-funcionalidad.md"
    echo "  $0 list-epics"
    echo ""
    echo "WORKFLOW:"
    echo "  1. üéØ Generate issue: $0 generate EPIC-X \"feature\""
    echo "  2. üîß Execute issue: ./claude-issue-worker.sh [issue#] [area]"
    echo "  3. ‚úÖ Validate work: $0 validate [issue#]"
    echo ""
}

# Check if Claude Code is available
check_claude_availability() {
    if ! command -v claude &> /dev/null; then
        log_error "Claude Code not found. Please install Claude Code first."
        log_info "Install with: curl -sSL https://claude.ai/install | sh"
        exit 1
    fi
}

# Check if GitHub CLI is available and authenticated
check_github_cli() {
    if ! command -v gh &> /dev/null; then
        log_error "GitHub CLI not found. Please install gh first."
        log_info "Install with: brew install gh (macOS) or visit https://cli.github.com/"
        exit 1
    fi

    if ! gh auth status &> /dev/null; then
        log_error "GitHub CLI not authenticated. Please login first."
        log_info "Run: gh auth login"
        exit 1
    fi

    log_success "GitHub CLI authenticated and ready"
}

# Validate we're in the correct directory
check_project_structure() {
    if [[ ! -f "package.json" ]] || [[ ! -d "src" ]] || [[ ! -d "specs" ]]; then
        log_error "Please run this script from the Janome project root directory"
        log_info "Expected structure: package.json, src/, specs/"
        exit 1
    fi
}

# List available epics
list_epics() {
    log_epic "√âPICAS DISPONIBLES EN JANOME"
    echo ""
    echo "üéØ EPIC-TALLERES - Gesti√≥n de Talleres"
    echo "   ‚îî‚îÄ‚îÄ Programaci√≥n, Confirmaciones, Estados, Reportes"
    echo ""
    echo "üë• EPIC-ASISTENTES - Gesti√≥n de Participantes"
    echo "   ‚îî‚îÄ‚îÄ Perfiles, Equipos, Inscripciones, Historial"
    echo ""
    echo "üîß EPIC-EQUIPOS - Cat√°logo de M√°quinas"
    echo "   ‚îî‚îÄ‚îÄ Cat√°logo, Tipos, Compatibilidad, Asignaciones"
    echo ""
    echo "üì± EPIC-RECORDATORIOS - Sistema WhatsApp"
    echo "   ‚îî‚îÄ‚îÄ Cron Jobs, Templates, Estad√≠sticas, Bulk"
    echo ""
    echo "üë§ EPIC-USUARIOS - Autenticaci√≥n y Roles"
    echo "   ‚îî‚îÄ‚îÄ Auth, Roles, Estados, Aprobaciones"
    echo ""
    echo "ü§ñ EPIC-IA-WHATSAPP - Integraci√≥n IA"
    echo "   ‚îî‚îÄ‚îÄ Chatbot, Escalamiento, Contexto, An√°lisis"
    echo ""
    echo "üìä EPIC-DASHBOARD - M√©tricas y Reportes"
    echo "   ‚îî‚îÄ‚îÄ Widgets, Gr√°ficos, Exportes, Alertas"
    echo ""
    echo "üîß EPIC-PERFORMANCE - Optimizaciones"
    echo "   ‚îî‚îÄ‚îÄ BD, Frontend, Worker, Monitoring"
    echo ""
    echo "üîß EPIC-DOCS - Documentaci√≥n"
    echo "   ‚îî‚îÄ‚îÄ Creaci√≥n de documentos .md como bit√°cora del proyecto."
}

# Analyze requirement and suggest structure
analyze_requirement() {
    local requirement="$1"

    log_info "Analizando requerimiento para estructura de issues..."

    claude "MODO: AN√ÅLISIS DE REQUERIMIENTO JANOME

Analiza este requerimiento y prop√≥n la estructura de issues:

REQUERIMIENTO: $requirement

## CONTEXTO DEL PROYECTO JANOME
Este es el Panel Administrativo Janome - un sistema de gesti√≥n de talleres, asistentes y equipos industriales.
Stack: React + TypeScript + Vite + Supabase + Cloudflare Workers
Protocolo: C.I.D.E.R. (Contextualizar, Iterar, Documentar, Ejecutar, Reflexionar)

Tienes acceso a la documentaci√≥n completa en:
- specs/00_SYSTEM/_MANIFEST.md (estado global)
- specs/03_DATABASE/_DATABASE_OVERVIEW.md (funciones BD)
- CLAUDE.md (contexto de desarrollo)

## √âPICAS DISPONIBLES:
üéØ EPIC-TALLERES - Gesti√≥n de Talleres
üë• EPIC-ASISTENTES - Gesti√≥n de Participantes
üîß EPIC-EQUIPOS - Cat√°logo de M√°quinas
üì± EPIC-RECORDATORIOS - Sistema WhatsApp
üë§ EPIC-USUARIOS - Autenticaci√≥n y Roles
ü§ñ EPIC-IA-WHATSAPP - Integraci√≥n IA
üìä EPIC-DASHBOARD - M√©tricas y Reportes
üîß EPIC-PERFORMANCE - Optimizaciones
üîß EPIC-DOCS - Documentaci√≥n

## TAREAS REQUERIDAS:
1. üéØ Identifica la √âPICA principal (y secundarias si aplican)
2. üìã Desglosa en issues at√≥micas (cada una independiente)
3. üîó Establece dependencias entre issues
4. ‚è±Ô∏è Estima complejidad: SIMPLE(15min-2h) | MEDIUM(2h-6h) | COMPLEX(6h-24h)
5. üìÖ Prop√≥n orden l√≥gico de desarrollo
6. ‚ö†Ô∏è Identifica riesgos o blockers potenciales
7. üèóÔ∏è Sugiere si requiere investigaci√≥n previa o pruebas de concepto

## FORMATO DE SALIDA ESPERADO:
### √âPICA PRINCIPAL: [nombre]
### ISSUES AT√ìMICAS SUGERIDAS:
1. [TIPO]-(fecha)-[nombre] - COMPLEJIDAD: [nivel] - AREA: [area]
   Descripci√≥n: [qu√© hace espec√≠ficamente]
   Dependencias: [issues relacionadas]

2. [continuar...]

### ORDEN DE DESARROLLO:
1. Issue #1 (prerequisito)
2. Issue #2 (puede ir en paralelo)
...

### RIESGOS IDENTIFICADOS:
- [riesgo 1]: [mitigaci√≥n sugerida]
- [riesgo 2]: [mitigaci√≥n sugerida]

S√© espec√≠fico y pr√°ctico. Cada issue debe ser implementable independientemente." \
        --allowedTools "Read" "Write" \
        "Bash(gh:*)" "Bash(rg:*)" "Bash(find:*)" "Bash(ls:*)" "Bash(grep:*)" \
        "Bash(npm:*)" "Bash(git:*)" "Bash(cd:*)" "Bash(npx:*)" \
        "mcp_supabase_*" "fetch_pull_request"

    log_success "An√°lisis completado. Revisa la propuesta y genera las issues espec√≠ficas."
}

# Generate atomic issue and create it in GitHub via Claude Code
generate_issue() {
    local epic="$1"
    local feature="$2"

    log_generate "Generando y creando issue at√≥mica para $epic: $feature"

    # Validate epic
    case $epic in
        EPIC-TALLERES|EPIC-ASISTENTES|EPIC-EQUIPOS|EPIC-RECORDATORIOS|EPIC-USUARIOS|EPIC-IA-WHATSAPP|EPIC-DASHBOARD|EPIC-PERFORMANCE|EPIC-DOCS)
            ;;
        *)
            log_error "√âpica no v√°lida: $epic"
            log_info "Usa: list-epics para ver √©picas disponibles"
            exit 1
            ;;
    esac

    # Map epic to GitHub label
    local epic_label
    case $epic in
        EPIC-TALLERES) epic_label="epic:talleres" ;;
        EPIC-ASISTENTES) epic_label="epic:asistentes" ;;
        EPIC-EQUIPOS) epic_label="epic:equipos" ;;
        EPIC-RECORDATORIOS) epic_label="epic:recordatorios" ;;
        EPIC-USUARIOS) epic_label="epic:usuarios" ;;
        EPIC-IA-WHATSAPP) epic_label="epic:ia-whatsapp" ;;
        EPIC-DASHBOARD) epic_label="epic:dashboard" ;;
        EPIC-PERFORMANCE) epic_label="epic:performance" ;;
        EPIC-DOCS) epic_label="epic:docs" ;;
    esac

    # Determine suggested area automatically
    local suggested_area="frontend"
    if echo "$feature" | grep -qi "worker\|cron\|whatsapp\|reminder"; then
        suggested_area="worker"
    elif echo "$feature" | grep -qi "database\|function\|migration\|table"; then
        suggested_area="database"
    elif echo "$feature" | grep -qi "doc\|spec\|readme\|plan\|staging\|production\|deploy"; then
        suggested_area="docs"
    fi

    # Generate date for title
    local date=$(date +%d-%m-%Y)
    local title="[FEAT]-($date)-[...]"

    log_info "Ejecutando Claude Code para generar y crear la issue..."
    log_info "T√≠tulo sugerido: $title"
    log_info "Labels sugeridos: $epic_label"
    log_info "√Årea sugerida: $suggested_area"

    # Execute Claude Code with direct GitHub issue creation
    claude "MODO: GENERADOR DE ISSUE JANOME + CREACI√ìN EN GITHUB

## CONFIGURACI√ìN DE LA ISSUE
√âPICA: $epic
FUNCIONALIDAD: $feature
T√çTULO SUGERIDO: $title
LABELS SUGERIDOS: $epic_label,√ÅREA SUGERIDA: $suggested_area

## TU TAREA COMPLETA:
1. üìñ Lee OBLIGATORIAMENTE estos archivos para contextualizar:
   - CLAUDE.md (reglas y protocolo de desarrollo)
   - specs/00_SYSTEM/_MANIFEST.md (estado global del sistema)
   - specs/03_DATABASE/_DATABASE_OVERVIEW.md (funciones BD disponibles)

2. üìù Genera el contenido completo de la issue siguiendo protocolo C.I.D.E.R.:

## üéØ **√âPICA PADRE**: $epic
## üîß **√ÅREA DE TRABAJO**: $suggested_area (o ajusta seg√∫n an√°lisis)
## ‚è±Ô∏è **COMPLEJIDAD**: [SIMPLE|MEDIUM|COMPLEX] - [15min-2h|2h-6h|6h-24h]

---

## üìã **CONTEXTUALIZACI√ìN (C.I.D.E.R.)**

### **üéØ Objetivo de la Issue**
[Descripci√≥n clara y espec√≠fica de qu√© se va a implementar]

### **üîó Dependencias**
- **Archivos cr√≠ticos**: [Lista de archivos que se van a modificar]
- **Funciones BD**: [Funciones de Supabase involucradas si aplica]
- **Issues relacionadas**: [Si aplica]

### **üìä Contexto de Negocio**
- **Valor para el usuario**: [C√≥mo impacta la experiencia del usuario]
- **Casos de uso**: [Escenarios espec√≠ficos donde se usa]

---

## üîÑ **ITERACI√ìN Y PLANIFICACI√ìN (C.I.D.E.R.)**

### **üìã An√°lisis de Impacto**
- [ ] **Frontend**: [Componentes que se van a modificar/crear]
- [ ] **Backend/BD**: [Funciones/tablas que se van a modificar]
- [ ] **Worker**: [Scripts o endpoints que se van a tocar]
- [ ] **Documentaci√≥n**: [Archivos de specs que se van a actualizar]

### **üéØ Definici√≥n de \"Terminado\"**
- [ ] **Funcionalidad**: [Criterios espec√≠ficos de funcionalidad]
- [ ] **Testing**: [Qu√© se debe probar y c√≥mo]
- [ ] **Documentaci√≥n**: [Qu√© documentos se deben actualizar]
- [ ] **Build**: [npm run build exitoso + type-check]

---

## ‚ö° **EJECUCI√ìN T√âCNICA (C.I.D.E.R.)**

### **üõ†Ô∏è Plan de Implementaci√≥n**

#### **FASE 1: Preparaci√≥n**
- [ ] Leer specs relevantes
- [ ] Verificar funciones BD con Supabase MCP (si aplica)
- [ ] Confirmar estado del build: \`npm run build\`

#### **FASE 2: Desarrollo**
- [ ] **[Paso espec√≠fico 1]**: [Descripci√≥n detallada]
- [ ] **[Paso espec√≠fico 2]**: [Descripci√≥n detallada]
- [ ] **Testing incremental**: [Despu√©s de cada paso cr√≠tico]

#### **FASE 3: Validaci√≥n**
- [ ] **Build check**: \`npm run build\` exitoso
- [ ] **Type check**: \`npm run type-check\` sin errores
- [ ] **Testing manual**: [Funcionalidad en browser si aplica]

---

## üîç **REFLEXI√ìN Y VERIFICACI√ìN (C.I.D.E.R.)**

### **‚úÖ Criterios de Aceptaci√≥n**
- [ ] **Funcional**: [La funcionalidad trabaja seg√∫n especificaci√≥n]
- [ ] **T√©cnico**: [Build exitoso + tipos correctos]
- [ ] **UX**: [Interfaz intuitiva y responsive si aplica]

### **üö® Consideraciones Cr√≠ticas Janome**
- **Timezone**: Todas las fechas en \`America/Santiago\` (si aplica)
- **BD Functions**: Consultar estado real con Supabase MCP (si aplica)
- **Worker**: Si se modifica, testing obligatorio

---

## üìù **Para Ejecutar Esta Issue**
\`\`\`bash
./claude-issue-worker.sh [NUMERO-ISSUE] $suggested_area
\`\`\`

3. üöÄ CREAR LA ISSUE EN GITHUB:
   Usa la herramienta gh para crear la issue con:
   - T√≠tulo: $title
   - Contenido: el body generado arriba
   - Labels: $epic_label
   - Asignado a: @me

4. üìä REPORTAR √âXITO:
   Al final, reporta el n√∫mero de issue creada y el comando para ejecutarla.

INSTRUCCIONES ESPEC√çFICAS:
- Estima complejidad realista basada en la funcionalidad
- Identifica archivos exactos que se van a modificar
- Consulta funciones BD reales si es relevante
- S√© espec√≠fico en criterios de aceptaci√≥n
- Incluye consideraciones del timezone America/Santiago cuando corresponda

¬°Procede a generar y crear la issue!" \
        --allowedTools "Read" "Write" \
        "Bash(gh:*)" "Bash(rg:*)" "Bash(find:*)" "Bash(ls:*)" "Bash(grep:*)" \
        "Bash(npm:*)" "Bash(git:*)" "Bash(cd:*)" "Bash(npx:*)" \
        "mcp_supabase_*" "fetch_pull_request"

    if [ $? -eq 0 ]; then
        log_success "Claude Code ejecutado exitosamente"
        log_info "La issue deber√≠a estar creada en GitHub"
        log_info "Revisa la salida de Claude Code arriba para obtener el n√∫mero de issue"
    else
        log_error "Error al ejecutar Claude Code"
        exit 1
    fi
}

# Validate existing issue (GitHub issue number or local file)
validate_issue() {
    local input="$1"
    local issue_content

    # Check if input is a GitHub issue number or URL
    if [[ "$input" =~ ^[0-9]+$ ]] || [[ "$input" =~ github\.com.*issues/[0-9]+ ]]; then
        log_info "Obteniendo contenido de GitHub issue: $input"

        # Extract issue number if it's a URL
        local issue_number="$input"
        if [[ "$input" =~ github\.com.*issues/([0-9]+) ]]; then
            issue_number="${BASH_REMATCH[1]}"
        fi

        # Get issue content from GitHub
        issue_content=$(gh issue view "$issue_number" --json body --jq '.body' 2>/dev/null)
        if [ $? -ne 0 ]; then
            log_error "No se pudo obtener la issue #$issue_number de GitHub"
            exit 1
        fi

        log_info "Validando GitHub issue #$issue_number"
    else
        # Treat as local file
        if [[ ! -f "$input" ]]; then
            log_error "Archivo no encontrado: $input"
            exit 1
        fi

        issue_content=$(cat "$input")
        log_info "Validando archivo local: $input"
    fi

    claude "MODO: VALIDACI√ìN DE ISSUES JANOME

Analiza este contenido de issue y valida que cumple con los est√°ndares de JANOME-ISSUE-TEMPLATE:

CONTENIDO DE LA ISSUE:
$issue_content

## CRITERIOS DE VALIDACI√ìN:

### 1. ESTRUCTURA Y FORMATO ‚úÖ‚ùå
- [ ] T√≠tulo sigue formato: [TIPO]-(DD-MM-YYYY)-[NOMBRE-FUNCIONALIDAD]
- [ ] Contiene secci√≥n √âPICA PADRE
- [ ] Contiene secci√≥n √ÅREA DE TRABAJO
- [ ] Contiene secci√≥n COMPLEJIDAD con estimaci√≥n

### 2. CONTEXTUALIZACI√ìN (C.I.D.E.R.) ‚úÖ‚ùå
- [ ] Objetivo claro y espec√≠fico
- [ ] Dependencias bien identificadas
- [ ] Contexto de negocio explicado
- [ ] Casos de uso espec√≠ficos

### 3. PLANIFICACI√ìN (C.I.D.E.R.) ‚úÖ‚ùå
- [ ] An√°lisis de impacto por √°rea (Frontend/Backend/Worker/Docs)
- [ ] Definici√≥n clara de \"Terminado\"
- [ ] Criterios de aceptaci√≥n espec√≠ficos y medibles

### 4. DOCUMENTACI√ìN (C.I.D.E.R.) ‚úÖ‚ùå
- [ ] Referencias correctas a specs/
- [ ] Funciones BD relevantes identificadas
- [ ] Archivos t√©cnicos espec√≠ficos mencionados

### 5. EJECUCI√ìN (C.I.D.E.R.) ‚úÖ‚ùå
- [ ] Plan de implementaci√≥n en fases
- [ ] Pasos espec√≠ficos y accionables
- [ ] Consideraciones de testing incluidas

### 6. REFLEXI√ìN (C.I.D.E.R.) ‚úÖ‚ùå
- [ ] Criterios de aceptaci√≥n claros
- [ ] M√©tricas de calidad definidas
- [ ] Consideraciones cr√≠ticas de Janome incluidas

### 7. ATOMICIDAD Y EJECUTABILIDAD ‚úÖ‚ùå
- [ ] Issue es independiente (sin dependencias bloqueantes)
- [ ] Scope apropiado para la complejidad estimada
- [ ] Ejecutable por una persona en el tiempo estimado

## SALIDA REQUERIDA:
1. üìä Puntuaci√≥n general: X/10
2. ‚úÖ Elementos que cumple
3. ‚ùå Elementos que faltan o est√°n mal
4. üí° Sugerencias espec√≠ficas de mejora
5. üéØ Recomendaci√≥n: APROBAR / REVISAR / RECHAZAR

Lee el contenido completo y provee feedback constructivo." \
        --allowedTools "Read" "Write" \
        "Bash(gh:*)" "Bash(rg:*)" "Bash(find:*)" "Bash(ls:*)" "Bash(grep:*)" \
        "Bash(npm:*)" "Bash(git:*)" "Bash(cd:*)" "Bash(npx:*)" \
        "mcp_supabase_*" "fetch_pull_request"

    log_success "Validaci√≥n completada. Revisa el feedback para mejorar la issue."
}

# Generate empty template
generate_template() {
    local date=$(date +%d-%m-%Y)
    local template_file="specs/01_FEATURES/[FEAT]-($date)-nueva-funcionalidad.md"

    log_generate "Generando template vac√≠o en: $template_file"

    cat > "$template_file" << 'EOF'
# [FEAT]-(DD-MM-YYYY)-[NOMBRE-FUNCIONALIDAD]

## üéØ **√âPICA PADRE**: [EPIC-NOMBRE]
## üîß **√ÅREA DE TRABAJO**: [frontend|worker|database|docs|full-stack]
## ‚è±Ô∏è **COMPLEJIDAD**: [SIMPLE|MEDIUM|COMPLEX] - [15min-2h|2h-6h|6h-24h]

---

## üìã **CONTEXTUALIZACI√ìN (C.I.D.E.R.)**

### **üéØ Objetivo de la Issue**
[Descripci√≥n clara y espec√≠fica de qu√© se va a implementar]

### **üîó Dependencias**
- **Archivos cr√≠ticos**: [Lista de archivos que se van a modificar]
- **Funciones BD**: [Funciones de Supabase involucradas]
- **Issues relacionadas**: #[numero] #[numero]
- **√âpicas dependientes**: [Si aplica]

### **üìä Contexto de Negocio**
- **Valor para el usuario**: [C√≥mo impacta la experiencia del usuario]
- **Casos de uso**: [Escenarios espec√≠ficos donde se usa]
- **M√©tricas de √©xito**: [C√≥mo medir que funciona correctamente]

---

## üîÑ **ITERACI√ìN Y PLANIFICACI√ìN (C.I.D.E.R.)**

### **üìã An√°lisis de Impacto**
- [ ] **Frontend**: [Componentes que se van a modificar/crear]
- [ ] **Backend/BD**: [Funciones/tablas que se van a modificar]
- [ ] **Worker**: [Scripts o endpoints que se van a tocar]
- [ ] **Documentaci√≥n**: [Archivos de specs que se van a actualizar]

### **üéØ Definici√≥n de "Terminado"**
- [ ] **Funcionalidad**: [Criterios espec√≠ficos de funcionalidad]
- [ ] **Testing**: [Qu√© se debe probar y c√≥mo]
- [ ] **Documentaci√≥n**: [Qu√© documentos se deben actualizar]
- [ ] **Build**: [npm run build exitoso + type-check]

---

## üìö **DOCUMENTACI√ìN REQUERIDA (C.I.D.E.R.)**

### **üìù Archivos de Especificaci√≥n**
- [ ] **Spec Principal**: `specs/01_FEATURES/[FEAT]-[nombre].md`
- [ ] **BD Updates**: `specs/03_DATABASE/[archivo-relevante].sql` (si aplica)
- [ ] **Log de Trabajo**: `specs/02_LOGS/[LOG]-[nombre].md`

### **üîó Referencias T√©cnicas**
- **Funciones BD relevantes**: [Lista espec√≠fica de funciones]
- **Componentes afectados**: [Lista de componentes React]
- **Tipos TypeScript**: [Interfaces/tipos que se modifican]

---

## ‚ö° **EJECUCI√ìN T√âCNICA (C.I.D.E.R.)**

### **üõ†Ô∏è Plan de Implementaci√≥n**

#### **FASE 1: Preparaci√≥n**
- [ ] Leer specs/00_SYSTEM/_MANIFEST.md
- [ ] Revisar specs/03_DATABASE/_DATABASE_OVERVIEW.md
- [ ] Verificar funciones BD relevantes con Supabase MCP
- [ ] Confirmar estado actual del build: `npm run build`

#### **FASE 2: Desarrollo**
- [ ] **[Paso espec√≠fico 1]**: [Descripci√≥n detallada]
- [ ] **[Paso espec√≠fico 2]**: [Descripci√≥n detallada]
- [ ] **[Paso espec√≠fico 3]**: [Descripci√≥n detallada]
- [ ] **Testing incremental**: [Despu√©s de cada paso cr√≠tico]

#### **FASE 3: Validaci√≥n**
- [ ] **Build check**: `npm run build` exitoso
- [ ] **Type check**: `npm run type-check` sin errores
- [ ] **Testing manual**: [Funcionalidad en http://localhost:5173/]
- [ ] **Worker testing**: [Si aplica] `cd worker && npm test`

---

## üîç **REFLEXI√ìN Y VERIFICACI√ìN (C.I.D.E.R.)**

### **‚úÖ Criterios de Aceptaci√≥n**
- [ ] **Funcional**: [La funcionalidad trabaja seg√∫n especificaci√≥n]
- [ ] **T√©cnico**: [Build exitoso + tipos correctos]
- [ ] **UX**: [Interfaz intuitiva y responsive]
- [ ] **Performance**: [No degradaci√≥n notable]

### **üìä M√©tricas de Calidad**
- [ ] **Sin errores TypeScript**: `npm run type-check`
- [ ] **Sin errores de build**: `npm run build`
- [ ] **Testing manual exitoso**: Browser testing
- [ ] **Documentaci√≥n actualizada**: Specs relevantes

---

## üö® **CONSIDERACIONES CR√çTICAS JANOME**

### **‚ö†Ô∏è Reglas Obligatorias**
- **Timezone**: Todas las fechas en `America/Santiago`
- **BD Functions**: Consultar estado real con Supabase MCP
- **Worker**: Si se modifica, testing obligatorio
- **Build**: Nunca commitear c√≥digo que rompa el build

### **üîó Recursos de Desarrollo**
- **Supabase Project**: `rqholbdnefyfokrozkih`
- **Worker URL**: `https://janome-whatsapp-reminders-production.oficina-c3f.workers.dev/`
- **Local Dev**: `http://localhost:5173/`

---

## üìÖ **INFORMACI√ìN DE TRACKING**

**Creado**: [DD/MM/YYYY]
**Asignado**: [@username]
**Epic**: [EPIC-NOMBRE]
**Estimaci√≥n**: [tiempo estimado]
**Prioridad**: [ALTA|MEDIA|BAJA]

EOF

    log_success "Template generado en: $template_file"
    log_info "Edita el archivo y completa los campos marcados con [brackets]"
}

# Main script logic
main() {
    if [ $# -eq 0 ]; then
        show_usage
        exit 1
    fi

    local command="$1"
    shift

    case $command in
        "analyze")
            # Check prerequisites for commands that need Claude Code
            check_claude_availability
            check_project_structure

            if [ $# -eq 0 ]; then
                log_error "Requirement description required for analyze command"
                echo "Usage: $0 analyze \"<requirement description>\""
                exit 1
            fi
            analyze_requirement "$*"
            ;;
        "generate")
            # Check prerequisites for commands that need Claude Code and GitHub CLI
            check_claude_availability
            check_github_cli
            check_project_structure

            if [ $# -lt 2 ]; then
                log_error "Epic and feature required for generate command"
                echo "Usage: $0 generate <epic> <feature>"
                exit 1
            fi
            generate_issue "$1" "${*:2}"
            ;;
        "validate")
            # Check prerequisites for commands that need Claude Code and possibly GitHub CLI
            check_claude_availability
            check_project_structure

            # Only check GitHub CLI if input looks like an issue number or GitHub URL
            if [[ "$1" =~ ^[0-9]+$ ]] || [[ "$1" =~ github\.com.*issues/[0-9]+ ]]; then
                check_github_cli
            fi

            if [ $# -eq 0 ]; then
                log_error "Issue number, GitHub URL, or local file required for validate command"
                echo "Usage: $0 validate <issue_number|github_url|local_file>"
                exit 1
            fi
            validate_issue "$1"
            ;;
        "list-epics")
            # This command doesn't need Claude Code
            list_epics
            ;;
        "template")
            # This command doesn't need Claude Code but needs project structure
            check_project_structure
            generate_template
            ;;
        *)
            log_error "Unknown command: $command"
            show_usage
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"